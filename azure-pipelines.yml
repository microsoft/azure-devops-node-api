steps:
- task: NodeTool@0
  inputs:
    versionSpec: "8.x"
  displayName: Install node 8

# install dependencies
- script: npm install
  displayName: npm install

# build
- script: npm run build
  displayName: npm run build

# test using node 8.x
- script: npm run units
  displayName: Run unit tests

# test using node 10.x
- task: NodeTool@0
  inputs:
    versionSpec: "10.x"
  displayName: Install node 10

- script: npm run units
  displayName: npm run units

# test using node 14.x
- task: NodeTool@0
  inputs:
    versionSpec: "14.x"
  displayName: Install node 14

- script: npm run units
  displayName: npm run units

# For CI runs on master, automatically publish packages
- bash: |
      echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
      cd _build
      npm publish || true # Ignore publish failures, usually will happen because package already exists
  displayName: npm publish
  condition: and(succeeded(), in(variables['build.reason'], 'IndividualCI', 'BatchedCI', 'Manual'), eq(variables['build.sourcebranchname'], 'master'))
  env:
    NPM_TOKEN: $(npmPublishToken)
